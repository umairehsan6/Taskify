
  <div class="main-content">
    <!-- Users Section -->
    <div id="userSection" class="glass-card">
      <h3 class="text-center mb-4">User Management</h3>
      {% if messages %}
        <div class="text-center">
          {% for message in messages %}
            <p class="fw-bold text-{{ message.tags }}">{{ message }}</p>
          {% endfor %}
        </div>
      {% endif %}
      <div class="d-flex justify-content-end mb-3 gap-2">
        <a href="{% url 'add_user' %}" class="btn btn-secondary">Add New User</a>
      </div>
      <div class="table-responsive">
        <table class="table">
          <thead>
            <tr>
              <th>#</th>
              <th>First Name</th>
              <th>Last Name</th>
              <th>Username</th>
              <th>Email</th>
              <th>Role</th>
              <th>Department</th>
              <th>Access</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for user in users %}
            <tr>
              <td>{{ forloop.counter }}</td>
              <td>{{ user.first_name }}</td>
              <td>{{ user.last_name }}</td>
              <td>{{ user.username }}</td>
              <td>{{ user.email }}</td>
              <td>{{ user.get_role_display }}</td>
              <td>
                {% with user.userdepartment_set.first as user_department %}
                    {% if user_department %}
                        {{ user_department.department.name }}
                    {% else %}
                        Not Assigned
                    {% endif %}
                {% endwith %}
            </td>
              <td><span class="badge {% if user.status %}bg-success{% else %}bg-danger{% endif %} rounded-pill">{% if user.status %}Active{% else %}Disabled{% endif %}</span></td>
              <td>
                <div class="d-flex justify-content-center">
                  <div class="dropdown me-2">
                    <button class="btn btn-primary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">Promote</button>
                    <ul class="dropdown-menu">
                      <li><a class="dropdown-item" href="{% url 'promote_user' user.id 'employee' %}">Employee</a></li>
                      <li><a class="dropdown-item" href="{% url 'promote_user' user.id 'teamlead' %}">Team Lead</a></li>
                      <li><a class="dropdown-item" href="{% url 'promote_user' user.id 'project_manager' %}">Project Manager</a></li>
                      <li><a class="dropdown-item" href="{% url 'promote_user' user.id 'admin' %}">Admin</a></li>
                    </ul>
                  </div>
                  <div class="dropdown me-2">
                    <button class="btn btn-primary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                        Assign Department
                    </button>
                    <ul class="dropdown-menu">
                        {% for dept in departments %}
                        <li>
                            <a class="dropdown-item" href="{% url 'assign_department' user.id dept.id %}">
                                {{ dept.name }}
                            </a>
                        </li>
                        {% endfor %}
                    </ul>
                  </div>
                  <a href="{% url 'toggle_status' user.id %}" class="btn {% if user.status %}btn-danger{% else %}btn-success{% endif %} rounded-pill">{% if user.status %}Disable{% else %}Activate{% endif %}</a>
                </div>
              </td>
            </tr>
            {% empty %}
            <tr><td colspan="8" class="text-center">No users found.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Department Section -->
    <div id="departmentSection" class="glass-card d-none">
      <h3 class="text-center mb-4">Manage Departments</h3>
      <form method="POST" action="{% url 'add_department' %}">
        {% csrf_token %}
        <div class="input-group mb-3">
            <input type="text" name="department_name" class="form-control" placeholder="New Department" required />
            <button class="btn btn-success" type="submit">Add</button>
        </div>
      </form>
      <div class="table-responsive">
        <table class="table">
          <thead>
            <tr>
              <th>#</th>
              <th>Department Name</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            {% for dept in departments %}
            <tr>
              <td>{{ forloop.counter }}</td>
              <td>{{ dept.name }}</td>
              <td><a href="{% url 'delete_department' dept.id %}" class="btn btn-danger btn-sm">Delete</a></td>
            </tr>
            {% empty %}
            <tr><td colspan="3" class="text-center">No departments found.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Assign Tasks Section -->
    <div id="assignTasksSection" class="glass-card d-none">
      <h3 class="text-center mb-4">New Project</h3>
      <form method="POST" action="{%url 'add_project'%}">
        {% csrf_token %}
        <div class="mb-3">
          <input type="text" name="project_name" class="form-control" placeholder="Project Name" required style="color: #fff; background-color: rgba(255,255,255,0.1);" />
        </div>
        <div class="mb-3">
          <textarea name="description" class="form-control" placeholder="Project Description" required rows="3" style="color: #fff; background-color: rgba(255,255,255,0.1);"></textarea>
        </div>
        <div class="mb-3">
          <select name="department" class="form-select custom-dropdown" required style="color: #fff; background-color: rgba(255,255,255,0.1);">
            <option value="" disabled selected>Select Department</option>
            {% for dept in departments %}
              <option value="{{ dept.id }}">{{ dept.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="row mb-3">
          <div class="col">
            <input type="date" name="start_date" class="form-control" required style="color: #fff; background-color: rgba(255,255,255,0.1);" />
          </div>
          <div class="col">
            <input type="date" name="end_date" class="form-control" required style="color: #fff; background-color: rgba(255,255,255,0.1);" />
          </div>
        </div>
        <div class="text-end">
          <button type="submit" class="btn btn-primary">Assign Task</button>
        </div>
      </form>
    </div>
    <!-- All Projects Section -->
    <div id="allProjectsSection" class="glass-card d-none">
      <h3 class="text-center mb-4">All Projects</h3>
      <div class="table-responsive">
  <table class="table">
    <thead>
      <tr>
        <th>#</th>
        <th>Project Name</th>
        <th>Department</th>
        <th>Description</th>
        <th>Start Date</th>
        <th>End Date</th>
        <th>Status</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for project in projects %}
      <tr>
        <td>{{ forloop.counter }}</td>
        <td>{{ project.name }}</td>
        <td>{{ project.department.name }}</td>
        <td>{{ project.description }}</td>
        <td>{{ project.start_date }}</td>
        <td>{{ project.end_date }}</td>
        <td>
          <span class="badge {% if project.status == 'pending' %}bg-warning 
            {% elif project.status == 'ongoing' %}bg-primary
            {% elif project.status == 'completed' %}bg-success 
            {% elif project.status == 'on_hold' %}bg-warning 
            {% elif project.status == 'cancelled' %}bg-danger
            {% endif %} rounded-pill">
            {{ project.get_status_display }}
          </span>
        </td>
        <td class="align-middle">
          <div class="d-flex align-items-center gap-2">
            <div class="dropdown">
              <button class="btn btn-primary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                Change Status
              </button>
              <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="{% url 'change-status' project.id 'ongoing' %}">Ongoing</a></li>
                <li><a class="dropdown-item" href="{% url 'change-status' project.id 'completed' %}">Completed</a></li>
                <li><a class="dropdown-item" href="{% url 'change-status' project.id 'on_hold' %}">Hold</a></li>
                <li><a class="dropdown-item" href="{% url 'change-status' project.id 'cancelled' %}">Cancel</a></li>
              </ul>
            </div>
            {% if project.status == 'ongoing' %}
              {% if user_role == 'admin' %}
              <button 
                type="button" 
                class="btn btn-outline-primary btn-sm d-inline-flex align-items-center gap-1" 
                data-bs-toggle="modal" 
                data-bs-target="#createTaskModal"
                data-project-id="{{ project.id }}">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-plus" viewBox="0 0 16 16">
                  <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
                </svg>
                Tasks
              </button>
              {% endif %}
            {% else %}
              <span class="text-muted small">
                {% if project.status == 'pending' %}
                  Project not started
                {% elif project.status == 'completed' %}
                  Project completed
                {% elif project.status == 'on_hold' %}
                  Project on hold
                {% elif project.status == 'cancelled' %}
                  Project cancelled
                {% endif %}
              </span>
            {% endif %}
          </div>
        </td>
      </tr>
      {% empty %}
      <tr><td colspan="8" class="text-center">No projects found.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>
    </div>

    <!-- Assigned Tasks Section -->
<div id="assignedTasksSection" class="glass-card d-none">
  <h3 class="text-center mb-4">Assigned Tasks</h3>
  <div class="mb-3">
    <label for="projectDropdown" class="form-label">Select Project</label>
    <select id="projectDropdown" class="form-select custom-dropdown" onchange="filterTasksByProject()">
      <option value="" disabled selected>Select a Project</option>
      {% for project in projects %}
        {% if project.status == 'ongoing' %}
          <option value="{{ project.id }}">{{ project.name }}</option>
        {% endif %}
      {% endfor %}
    </select>
  </div>
  <div id="tasksTableContainer" class="table-responsive d-none">
    <table class="table">
      <thead>
        <tr>
          <th>#</th>
          <th>Task Name</th>
          <th>Assigned To</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="tasksTableBody">
        <!-- Tasks will be dynamically populated here -->
      </tbody>
    </table>
  </div>
</div>

  </div>



  <!-- Modal for creating tasks -->
  <div class="modal fade" id="createTaskModal" tabindex="-1" aria-labelledby="createTaskModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="background: rgba(54, 54, 54, 0.89); color: white; border-radius: 10px; backdrop-filter: blur(10px);">
            <div class="modal-header" style="border-bottom: 1px solid rgba(255, 255, 255, 0.2);">
                <h5 class="modal-title" id="createTaskModalLabel">Create New Task</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="filter: invert(1);"></button>
            </div>
            <div class="modal-body">
                <form id="createTaskForm" method="POST" action="{% url 'create_task' %}">
                    {% csrf_token %}
                    <input type="hidden" name="project_id" value="{{ selected_project.id }}">
                    
                    <div class="mb-3">
                        <label for="project_name" class="form-label">Project Name</label>
                        <input type="text" class="form-control" name="project_name" readonly 
                            value="{{ selected_project.name }}" 
                            style="background: rgba(54, 54, 54, 0.89); border: 1px solid rgba(255, 255, 255, 0.2); color: white; border-radius: 5px;">
                    </div>
                    
                    <div class="mb-3">
                        <label for="assigned_to" class="form-label">Assigned To</label>
                        <select class="form-select" name="assigned_to" required 
                            style="background: rgba(54, 54, 54, 0.89); border: 1px solid rgba(255, 255, 255, 0.2); color: white; border-radius: 5px;">
                            <option value="">Select User</option>
                            {% for employee in filtered_employees %}
                                <option value="{{ employee.user.id }}">
                                    {{ employee.user.first_name }} {{ employee.user.last_name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="task_name" class="form-label">Task Name</label>
                        <input type="text" class="form-control" id="task_name" name="task_name" required style="background: rgba(54, 54, 54, 0.89); border: 1px solid rgba(255, 255, 255, 0.2); color: white; border-radius: 5px;">
                    </div>
                    
                    <div class="mb-3">
                        <label for="task_description" class="form-label">Description</label>
                        <textarea class="form-control" id="task_description" name="task_description" required rows="3" style="background: rgba(54, 54, 54, 0.89); border: 1px solid rgba(255, 255, 255, 0.2); color: white; border-radius: 5px;"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="priority" class="form-label">Priority</label>
                        <select class="form-select" id="priority" name="priority" required style="background: rgba(54, 54, 54, 0.89); border: 1px solid rgba(255, 255, 255, 0.2); color: white; border-radius: 5px;">
                            <option value="">Select Priority</option>
                            {% for value, label in task_priorities %}
                                <option value="{{ value }}">{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="duedate" class="form-label">Due Date</label>
                        <input type="date" class="form-control" id="duedate" name="duedate" required style="background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); color: white; border-radius: 5px;">
                    </div>
                    
                    <div class="modal-footer" style="border-top: 1px solid rgba(255, 255, 255, 0.2);">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Assign</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>
  <script>
    let currentActive = 'user'; // Default section is 'Users'

    function setActive(element, section) {
      const userLink = document.getElementById('usersLink');
      const departmentLink = document.getElementById('departmentsLink');
      const assignLink = document.getElementById('assignTasksLink');
      const allProjectsLink = document.getElementById('allProjectsLink');


      userLink.classList.remove('active');
      departmentLink.classList.remove('active');
      assignLink.classList.remove('active');
      allProjectsLink.classList.remove('active');

      if (section === 'user') userLink.classList.add('active');
      else if (section === 'department') departmentLink.classList.add('active');
      else if (section === 'assign') assignLink.classList.add('active');
      else if (section === 'projects') allProjectsLink.classList.add('active');


      currentActive = section;
    }

    function showSection(id) {
      document.getElementById('userSection').classList.add('d-none');
      document.getElementById('departmentSection').classList.add('d-none');
      document.getElementById('assignTasksSection').classList.add('d-none');
      document.getElementById('allProjectsSection').classList.add('d-none');
      document.getElementById('assignedTasksSection').classList.add('d-none');
      document.getElementById(id).classList.remove('d-none');
    }



// Replace the existing event listener code with this:
document.addEventListener('DOMContentLoaded', function() {
  const modal = document.getElementById('createTaskModal');
  
  modal.addEventListener('show.bs.modal', function(event) {
                const button = event.relatedTarget;
                const projectId = button.getAttribute('data-project-id');
                const projectName = button.closest('tr').querySelector('td:nth-child(2)').textContent;

                // Update hidden project ID field
      const projectIdInput = modal.querySelector('input[name="project_id"]');
                projectIdInput.value = projectId;

                // Update project name display
      const projectNameInput = modal.querySelector('input[name="project_name"]');
                projectNameInput.value = projectName;
      
      // Update form action
      const form = modal.querySelector('#createTaskForm');
      form.action = `{% url 'create_task' %}?project_id=${projectId}`;
      
      // Fetch employees for the project's department
      fetch(`/admin-dashboard/?project_id=${projectId}`)
          .then(response => response.text())
          .then(html => {
              // Extract the filtered employees from the response
              const parser = new DOMParser();
              const doc = parser.parseFromString(html, 'text/html');
              const employeeSelect = modal.querySelector('select[name="assigned_to"]');
              const newEmployeeSelect = doc.querySelector('select[name="assigned_to"]');
              
              if (newEmployeeSelect) {
                  employeeSelect.innerHTML = newEmployeeSelect.innerHTML;
              }
          })
          .catch(error => console.error('Error:', error));
            });
    });

document.addEventListener('DOMContentLoaded', function () {
    const modals = document.querySelectorAll('.modal');
    modals.forEach(modal => {
        modal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const projectId = button.getAttribute('data-project-id');
            const modalTitle = modal.querySelector('.modal-title');
            modalTitle.textContent = `Tasks for Project ID: ${projectId}`;
        });
    });
});

function filterTasksByProject() {
    const projectId = document.getElementById('projectDropdown').value;
    const tasksTableContainer = document.getElementById('tasksTableContainer');
    const tasksTableBody = document.getElementById('tasksTableBody');

    if (!projectId) {
      tasksTableContainer.classList.add('d-none');
      return;
    }
    tasksTableBody.innerHTML = '';
    fetch(`/get-tasks/?project_id=${projectId}`)
      .then(response => response.json())
      .then(data => {
        if (data.tasks.length > 0) {
          tasksTableContainer.classList.remove('d-none');
          data.tasks.forEach((task, index) => {
            const row = `
              <tr>
                <td>${index + 1}</td>
                <td>${task.name}</td>
                <td>${task.assigned_to}</td>
                <td>
                  <span class="badge ${
                    task.status === 'completed' ? 'bg-success' : 'bg-primary'
                  } rounded-pill">${task.status_display}</span>
                </td>
                <td>
                  <a href="/delete-project/${task.id}/" class="btn btn-danger btn-sm">Delete</a>
                </td>
              </tr>
            `;
            tasksTableBody.innerHTML += row;
          });
        } else {
          tasksTableContainer.classList.remove('d-none');
          tasksTableBody.innerHTML = `
            <tr>
              <td colspan="5" class="text-center">No tasks found for this project.</td>
            </tr>
          `;
        }
      })
      .catch(error => {
        console.error('Error fetching tasks:', error);
      });
  }
  </script>
</body>
</html>
