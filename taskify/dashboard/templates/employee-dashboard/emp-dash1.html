{% extends "employee-dashboard/base.html" %}
{% load static %}

{% block title %}Dashboard Home | Taskify{% endblock %}

{% block content %}

    

    <div class="header-row">
        <div class="greeting-card d-flex align-items-center">
            <div class="greeting-text">
                <h2 class="mb-0">Hello 
                    {% if user_type == 'signup_user' %}
                        {{ username }}!
                    {% endif %}
                </h2>
                <p class="text-muted">It's good to see you again.</p>
            </div>
            <div class="greeting-image d-none d-lg-flex">
                <img
                  src="{% static 'employee-dashboard/images/welcome.jpg' %}"
                  alt="Welcome Graphic"
                  class="img-fluid"
                />
                <div class="image-overlay"></div>
            </div>
        </div>

        <div class="toolbar justify-content-end align-items-center">
            <div class="icons me-4 d-flex align-items-center">
                <!-- Profile Picture -->
                <a href="{% url 'employee_profile' %}" class="profile-link">
                    {% if profile.profile_picture %}
                        <img src="{{ profile.profile_picture.url }}" alt="Profile Picture" class="profile-picture-small">
                    {% else %}
                        <div class="profile-picture-small d-flex align-items-center justify-content-center">
                            <i class="fa fa-user text-muted"></i>
                        </div>
                    {% endif %}
                </a>
                <!-- Notification Bell -->
                <div class="notification-dropdown">
                    <button class="notification-bell" id="notificationBell" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fa fa-bell"></i>
                        <span id="notificationBadge" class="position-absolute top-0 start-50 translate-middle badge rounded-pill bg-danger" style="display:none;">0</span>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end p-0" id="notificationDropdown" style="width: 350px; border-radius: 12px; box-shadow: 0 4px 24px rgba(0,0,0,0.2);">
                        <li class="dropdown-header bg-dark text-white py-2 px-3" style="border-radius: 12px 12px 0 0;">Task Notifications</li>
                        <li id="notificationList">
                            <!-- Notifications will be loaded here by JS -->
                        </li>
                        <li class="dropdown-header bg-dark text-white py-2 px-3" style="border-radius: 12px 12px 0 0;">
                            <a href="{% url 'all-notifications' %}" id="seeAllNotificationsLink" class="text-decoration-none text-white d-flex align-items-center">
                                See All
                                <span id="seeAllUnreadBadge" class="badge bg-danger ms-2" style="display:none;"></span>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
            <button class="btn btn-primary d-flex align-items-center"
                    data-bs-toggle="modal"
                    data-bs-target="#createTaskModal"
                    data-project-id="{{ project.id }}"
                    data-project-name="{{ project.name }}">
                <span class="me-2"><i class="fa fa-plus"></i></span>
                <span>Create Task</span>
            </button>
        </div>
    </div>
    <h5 class="fw-semibold mb-3">Today</h5>
    <div class="row text-center mb-4">
        <div class="col-md-3">
            <div class="card p-3 mb-3">
                <h3 class="fw-bold" id="totalTimeToday">{{ total_time_today }}</h3>
                <p class="text-secondary">Hours Worked</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card p-3 mb-3">
                <h3 class="fw-bold">{{ tasks_done_today }}</h3>
                <p class="text-secondary">Tasks Done</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card p-3 mb-3">
                <h3 class="fw-bold">{{ tasks_expiring_today }}</h3>
                <p class="text-secondary">Tasks Expiring Today</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card p-3 mb-3">
                <h3 class="fw-bold">{{ expired_tasks }}</h3>
                <p class="text-secondary">Expired Tasks</p>
            </div>
        </div>
    </div>

    <h5 class="fw-semibold mb-3">Ongoing Projects</h5>
    <div class="row mb-4 align-items-stretch">
        {% if user_role in roles_with_access %}
            {% for project in projects %}
                {% if project.status in statuses_to_show and project.status != 'completed' %}
                    <div class="col-md-6 mb-3">
                        <div class="project-summary-card card p-3">
                            <h6 class="fw-semibold">{{ project.name }}</h6>
                            <p class="text-secondary">{{ project.description|truncatewords:15 }}</p>
                            <div>
                                <span class="badge 
                                    {% if project.status == 'pending' %}bg-warning
                                    {% elif project.status == 'ongoing' %}bg-success
                                    {% elif project.status == 'on_hold' %}bg-secondary
                                    {% endif %}">
                                    {{ project.get_status_display }}
                                </span>
                            </div>
                            <div class="project-card-buttons mt-3">
                                {% if has_permission %}
                                    {% if project.status == 'pending' %}
                                        <a href="{% url 'update-project-status' project.id 'ongoing' %}" class="btn btn-outline-primary">
                                            Start Project
                                        </a>
                                    {% elif project.status == 'ongoing' %}
                                        <a href="{% url 'update-project-status' project.id 'completed' %}" class="btn btn-outline-success">
                                            Complete Project
                                        </a>
                                        <button class="btn btn-outline-info position-relative"
                                            data-bs-toggle="modal"
                                            data-bs-target="#projectTasksModal"
                                            data-project-id="{{ project.id }}"
                                            data-project-name="{{ project.name }}">
                                            Show Tasks
                                            {% if project.has_unread_messages %}
                                            <span class="message-indicator" style="display: block !important;"></span>
                                            {% endif %}
                                        </button>
                                    {% endif %}
                                {% endif %}
                                <button class="btn btn-outline-secondary"
                                    data-bs-toggle="modal"
                                    data-bs-target="#projectDetailsModal"
                                    data-project-id="{{ project.id }}"
                                    data-project-name="{{ project.name }}"
                                    data-project-department="{{ project.department.name }}"
                                    data-project-due-date="{{ project.end_date|date:'F d, Y' }}"
                                    data-project-description="{{ project.description }}">
                                    See More
                                </button>
                            </div>
                        </div>
                    </div>
                {% endif %}
            {% empty %}
                <div class="col-12">
                    <div class="project-summary-card card p-3">
                        <p class="mb-0">No ongoing projects available.</p>
                    </div>
                </div>
            {% endfor %}
        {% elif user_role == 'employee' %}
            {% for project in projects %}
                {% if project.has_tasks_assigned and project.status != 'completed' %}
                    <div class="col-md-6 mb-3">
                        <div class="project-summary-card card p-3">
                            <h6 class="fw-semibold">{{ project.name }}</h6>
                            <p class="text-secondary">{{ project.description|truncatewords:15 }}</p>
                            <div>
                                <span class="badge 
                                    {% if project.status == 'pending' %}bg-warning
                                    {% elif project.status == 'ongoing' %}bg-success
                                    {% elif project.status == 'on_hold' %}bg-secondary
                                    {% endif %}">
                                    {{ project.get_status_display }}
                                </span>
                            </div>
                            <div class="project-card-buttons mt-3">
                                <button class="btn btn-outline-secondary"
                                    data-bs-toggle="modal"
                                    data-bs-target="#projectDetailsModal"
                                    data-project-id="{{ project.id }}"
                                    data-project-name="{{ project.name }}"
                                    data-project-department="{{ project.department.name }}"
                                    data-project-due-date="{{ project.end_date|date:'F d, Y' }}"
                                    data-project-description="{{ project.description }}">
                                    See More
                                </button>
                            </div>
                        </div>
                    </div>
                {% endif %}
            {% empty %}
                <div class="col-12">
                    <div class="project-summary-card card p-3">
                        <p class="mb-0">No ongoing projects available.</p>
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <div class="col-12">
                <div class="project-summary-card card p-3">
                    <p class="mb-0">No ongoing projects available.</p>
                </div>
            </div>
        {% endif %}
        <div class="col-12">
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8 mb-4">
            <div class="card stats-card p-3">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="fw-semibold mb-0">Ongoing tasks</h5>
                </div>
                {% comment %} <div id="ongoingTasksContainer">
                    {% for task in tasks %}
                        {% if task.status in "in_progress on_hold" %}
                            <div class="ongoing-task-item card p-3 mb-3" data-priority="{{ task.priority }}">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h6 class="fw-semibold mb-0">Task: {{ task.task_name }}</h6>
                                    <span class="badge 
                                        {% if task.priority == 'high' %}bg-danger
                                        {% elif task.priority == 'medium' %}bg-warning
                                        {% elif task.priority == 'low' %}bg-success
                                        {% endif %}">
                                        {{ task.get_priority_display }}
                                    </span>
                                </div>
                                <p class="mb-1">Project: <strong>{{ task.project.name }}</strong></p>
                                <p class="text-secondary mb-1">Description: 
                                    <strong>{{ task.task_description|truncatewords:15 }}</strong>
                                </p>
                                <p class="mb-1">Time Spent: <strong>{{ task.get_total_time_spent }}</strong></p>
                                <p class="mb-3">Due Date: <strong>{{ task.due_date|date:'F d, Y' }}</strong></p>
                                <p class="task-meta">Status: <strong>{{ task.get_status_display }}</strong></p>
                                <p class="task-meta">Expected Time: <strong>{{ task.get_expected_time_display }}</strong></p>
                                <div class="task-card-buttons d-flex gap-2 mt-2">
                                    <form method="POST" action="{% url 'complete_task' task.id %}" class="complete-task-form">
                                        {% csrf_token %}
                                        <button class="task-action-btn bg-primary text-white">
                                            <i class="fa fa-check-circle"></i>
                                            <span>Complete</span>
                                        </button>
                                    </form>
                                    {% if task.status == 'on_hold' %}
                                        <form method="POST" action="{% url 'start_working' task.id %}" class="start-working-form">
                                            {% csrf_token %}
                                            <button class="task-action-btn bg-success text-white">
                                                <i class="fa fa-play-circle"></i>
                                                <span>Start Working</span>
                                            </button>
                                        </form>
                                    {% elif task.status == 'in_progress' %}
                                        <form method="POST" action="{% url 'stop_working' task.id %}" class="stop-working-form">
                                            {% csrf_token %}
                                            <button class="task-action-btn bg-danger text-white">
                                                <i class="fa fa-stop-circle"></i>
                                                <span>Stop Working</span>
                                            </button>
                                        </form>
                                    {% endif %}
                                    <button class="task-action-btn bg-info text-white"
                                            data-bs-toggle="modal"
                                            data-bs-target="#viewFilesModal"
                                            data-task-id="{{ task.id }}"
                                            data-file-url="{% if task.task_file %}{{ task.task_file.url }}{% else %}#{% endif %}"
                                            data-file-name="{% if task.task_file %}{{ task.task_file.name|slice:'11:' }}{% else %}No file uploaded{% endif %}"
                                            data-report-text="{% if task.report %}{{ task.report }}{% else %}No report submitted{% endif %}">
                                        <i class="fa fa-upload"></i>
                                        <span>Files & Report</span>
                                    </button>
                                    <div class="position-relative">
                                    <button class="task-action-btn bg-dark text-white"
                                            data-bs-toggle="modal"
                                            data-bs-target="#commentsModal"
                                            data-task-id="{{ task.id }}"
                                            data-has-unread="{{ task.has_unread_messages|yesno:'true,false' }}">
                                        <i class="fas fa-comment-dots"></i>
                                        <span>Comments</span>
                                    </button>
                                    {% if task.has_unread_messages %}
                                    <span class="message-indicator" style="display: block;"></span>
                                    {% endif %}
                                    </div>
                                    <button class="task-action-btn bg-dark text-white"
                                            data-bs-toggle="modal"
                                            data-bs-target="#taskDetailsModal"
                                            data-task-name="{{ task.task_name }}"
                                            data-task-project="{{ task.project.name }}"
                                            data-task-priority="{{ task.get_priority_display }}"
                                            data-task-status="{{ task.get_status_display }}"
                                            data-task-due-date="{{ task.due_date|date:'F d, Y' }}"
                                            data-task-time-spent="{{ task.get_total_time_spent }}"
                                            data-task-description="{{ task.task_description }}">
                                        <i class="fa fa-info-circle"></i>
                                        <span>Read More</span>
                                    </button>
                                </div>
                            </div>
                        {% endif %}
                    {% empty %}
                        <div class="col-12">
                            <div class="ongoing-task-item card p-3 align-items-center" role="alert">
                                <p class="text-center mb-0">No ongoing tasks available.</p>
                            </div>
                        </div>
                    {% endfor %}
                </div> {% endcomment %}
                <div id="ongoingTasksContainer"></div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="mt-4">
                <h5 class="fw-semibold mb-3">Approval Pending</h5>
                {% comment %} {% if user_role in "teamlead project_manager" %}
                    {% for task in department_tasks %}
                        {% if task.status == 'not_assigned' %}
                            <div class="task-card card p-3 mb-3" data-priority="high">
                                <div class="priority-light"></div>
                                <h6 class="fw-semibold">Name: {{ task.task_name }}</h6>
                                <p class="text-secondary">Description: {{ task.task_description|truncatewords:8 }}</p>
                                <p>Due Date: {{ task.due_date }}</p>
                                <p>Status: {{ task.get_status_display }}</p>
                                <p>Project: {{ task.project.name }}</p>
                                <p>Department: {{ task.project.department.name }}</p>
                                <div class="task-card-buttons2 d-flex gap-2 mt-2">
                                    <form method="POST" action="{% url 'approve_task' task.id %}">
                                        {% csrf_token %}    
                                        <button class="task-action-btn">
                                            <i class="fa fa-check-circle"></i>
                                            <span>Approve</span>
                                        </button>
                                    </form>
                                    <form method="POST" action="#">
                                        {% csrf_token %}    
                                        <button class="task-action-btn">
                                            <i class="fa fa-times-circle"></i>
                                            <span>Reject</span>
                                        </button>
                                    </form>
                                    <button class="task-action-btn"
                                            data-bs-toggle="modal"
                                            data-bs-target="#taskDetailsModal"
                                            data-task-name="{{ task.task_name }}"
                                            data-task-project="{{ task.project.name }}"
                                            data-task-priority="{{ task.get_priority_display }}"
                                            data-task-status="{{ task.get_status_display }}"
                                            data-task-due-date="{{ task.due_date|date:'F d, Y' }}"
                                            data-task-time-spent="{{ task.get_total_time_spent }}"
                                            data-task-description="{{ task.task_description }}">
                                        <i class="fa fa-info-circle"></i>
                                        <span>Read More</span>
                                    </button>
                                </div>
                            </div>
                        {% endif %}
                    {% empty %}
                        <div class="card p-3 mb-3">
                            <p class="text-center mb-0">No Other Pending Approval</p>
                        </div>
                    {% endfor %}
                {% else %}
                    {% for task in tasks %}
                        {% if task.status == 'not_assigned' %}
                            <div class="task-card card p-3 mb-3" data-priority="high">
                                <div class="priority-light"></div>
                                <h6 class="fw-semibold">Name: {{ task.task_name }}</h6>
                                <p class="text-secondary">Description: {{ task.task_description|truncatewords:8 }}</p>
                                <p>Due Date: {{ task.due_date }}</p>
                                <p>Status: {{ task.get_status_display }}</p>
                                <div class="task-card-buttons2 d-flex gap-2 mt-2">
                                    <button class="task-action-btn"
                                            data-bs-toggle="modal"
                                            data-bs-target="#taskDetailsModal"
                                            data-task-name="{{ task.task_name }}"
                                            data-task-project="{{ task.project.name }}"
                                            data-task-priority="{{ task.get_priority_display }}"
                                            data-task-status="{{ task.get_status_display }}"
                                            data-task-due-date="{{ task.due_date|date:'F d, Y' }}"
                                            data-task-time-spent="{{ task.get_total_time_spent }}"
                                            data-task-description="{{ task.task_description }}">
                                        <i class="fa fa-info-circle"></i>
                                        <span>Read More</span>
                                    </button>
                                </div>
                            </div>
                        {% endif %}
                    {% endfor %}
                    <div class="card p-3">
                        <p class="text-center mb-0">No Other Pending Task</p>
                    </div>
                {% endif %} {% endcomment %}
                <div id="approvalPendingContainer">
                    <!-- Tasks will be loaded here dynamically -->
                    <div class="card p-3">
                        <p class="text-center mb-0">Loading...</p>
                    </div>
                </div>
            </div>

            <div class="mt-4">
                <h5 class="fw-semibold mb-3">Pending Tasks</h5>
                <div id="pendingTasksContainer">
                    {% comment %} {% for task in tasks %}
                        {% if task.status == 'pending' %}
                            <div class="task-card card p-3 mb-3" data-priority="high">
                                <div class="priority-light"></div>
                                <h6 class="fw-semibold">Name: {{ task.task_name }}</h6>
                                <p class="text-secondary">Description: {{ task.task_description|truncatewords:8 }}</p>
                                <p>Due Date: {{ task.due_date }}</p>
                                <p>Status: {{ task.get_status_display }}</p>
                                <div class="task-card-buttons2 d-flex gap-2 mt-2">
                                    <form method="POST" action="{% url 'start_task_initial' task.id %}">
                                        {% csrf_token %}    
                                        <button class="task-action-btn">
                                            <i class="fa fa-play-circle"></i>
                                            <span>Start Task</span>
                                        </button>
                                    </form>
                                    <button class="task-action-btn"
                                            data-bs-toggle="modal"
                                            data-bs-target="#taskDetailsModal"
                                            data-task-name="{{ task.task_name }}"
                                            data-task-project="{{ task.project.name }}"
                                            data-task-priority="{{ task.get_priority_display }}"
                                            data-task-status="{{ task.get_status_display }}"
                                            data-task-due-date="{{ task.due_date|date:'F d, Y' }}"
                                            data-task-time-spent="{{ task.get_total_time_spent }}"
                                            data-task-description="{{ task.task_description }}">
                                        <i class="fa fa-info-circle"></i>
                                        <span>Read More</span>
                                    </button>
                                </div>
                            </div>
                        {% endif %}
                    {% endfor %} {% endcomment %}
                </div>
                <div class="card p-3" id="no-pending-tasks-message" style="display: none;">
                    <p class="text-center mb-0">No Other Pending Task</p>
                </div>
            </div>
        </div>
    </div>

    {# — Modals — #}
    <!-- Project Details Modal -->
    <div class="modal fade" id="projectDetailsModal" tabindex="-1" aria-labelledby="projectDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content text-white" style="background-color: #121212; border-radius: 24px;">
                <div class="modal-header border-bottom border-secondary">
                    <h5 class="modal-title fw-bold" id="projectDetailsModalLabel">Project Details</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p><strong>Project Name:</strong> <span id="modalProjectName"></span></p>
                    <p><strong>Department:</strong> <span id="modalDepartment"></span></p>
                    <p><strong>Due Date:</strong> <span id="modalDueDate"></span></p>
                    <p><strong>Status:</strong> <span id="modalStatus" ></span></p>
                    <p><strong>Description:</strong></p>
                    <p id="modalDescription" class="mt-2" style="white-space: pre-wrap; line-height: 1.5;"></p>
                </div>
                
            </div>
        </div>
    </div>


    <!-- Comments Modal -->
    <div class="modal fade" id="commentsModal" tabindex="-1" aria-labelledby="commentsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="commentsModalLabel">Task Comments</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="taskId" value="">
                    <div id="commentsList" class="mb-3" style="max-height: 300px; overflow-y: auto;">
                        <!-- Comments will be loaded here -->
                        <div id="comments-bottom-anchor"></div>
                    </div>
                    <form id="commentForm" class="mt-3">
                        <div class="input-group">
                            <input type="text" id="messageInput" class="form-control" placeholder="Type your message...">
                            <button type="submit" class="btn btn-primary">Send</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Task Details Modal -->
    <div class="modal fade" id="taskDetailsModal" tabindex="-1" aria-labelledby="taskDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content text-white" style="background-color: #121212; border-radius: 24px;">
                <div class="modal-header border-bottom border-secondary">
                    <h5 class="modal-title fw-bold" id="taskDetailsModalLabel">Task Details</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p><strong>Task Name:</strong> <span id="modalTaskName"></span></p>
                    <p><strong>Project:</strong> <span id="modalProject"></span></p>
                    <p><strong>Priority:</strong> <span id="modalPriority"></span></p>
                    <p><strong>Status:</strong> <span id="modalTaskStatus"></span></p>
                    <p><strong>Due Date:</strong> <span id="modalTaskDueDate"></span></p>
                    <p><strong>Time Spent:</strong> <span id="modalTimeSpent"></span></p>
                    <p><strong>Description:</strong></p>
                    <p id="modalTaskDescription" class="mt-2" style="white-space: pre-wrap; line-height: 1.5;"></p>
                </div>
            </div>
        </div>
    </div>
    <!-- Create Task Modal -->
    <div class="modal fade" id="createTaskModal" tabindex="-1" aria-labelledby="createTaskModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content text-white" style="background-color: #121212; border-radius: 24px;">
                <div class="modal-header border-bottom border-secondary">
                    <h5 class="modal-title fw-bold" id="createTaskModalLabel">
                        {% if user_role == 'employee' %}
                            Create Task
                        {% else %}
                            Assign Task
                        {% endif %}
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="createTaskForm" method="POST" action="{% url 'create_task' %}">
                        {% csrf_token %}
                        <div id="createTaskMessage" class="alert alert-success d-none" role="alert">
                            Task created successfully!
                        </div>
                        <div class="mb-3">
                            <label for="project_id" class="form-label">Project</label>
                            <select class="form-select bg-dark text-white border-secondary" id="project_id" name="project_id" required>
                                <option value="">Select Project</option>
                                {% for project in projects %}
                                    {% if project.status == 'ongoing' %}
                                        <option value="{{ project.id }}">{{ project.name }}</option>
                                    {% endif %}
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="task_name" class="form-label">Task Name</label>
                            <input type="text" class="form-control bg-dark text-white border-secondary" id="task_name" name="task_name" required>
                        </div>
                        <div class="mb-3">
                            <label for="task_description" class="form-label">Description</label>
                            <textarea class="form-control bg-dark text-white border-secondary" id="task_description" name="task_description" rows="3" required></textarea>
                        </div>
                        <div class="mb-3 row">
                            <div class="col-md-6">
                                <label for="priority" class="form-label">Priority</label>
                                <select class="form-select bg-dark text-white border-secondary" id="priority" name="priority" required>
                                    {% for priority_value, priority_label in task_priorities %}
                                        <option value="{{ priority_value }}">{{ priority_label }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="duedate" class="form-label">Due Date</label>
                                <input type="date" class="form-control bg-dark text-white border-secondary" id="duedate" name="duedate" required>
                            </div>
                        </div>
                        <div class="mb-3 row">
                            <label for="expected_time" class="form-label">Expected Time</label>
                            <div class="col">
                                <label for="expected_time_hours">Hours</label>
                                <input type="number" class="form-control bg-dark text-white border-secondary" id="expected_time_hours" name="expected_time_hours" placeholder="HH" required>
                            </div>
                            <div class="col">
                                <label for="expected_time_minutes">Minutes</label>
                                <input type="number" class="form-control bg-dark text-white border-secondary" id="expected_time_minutes" name="expected_time_minutes" placeholder="MM" required>
                            </div>
                        </div>
                        {% if user_role != 'employee' %}
                        <div class="mb-3">
                            <label for="assigned_to" class="form-label">Assign To</label>
                            <select class="form-select bg-dark text-white border-secondary" id="assigned_to" name="assigned_to" required>
                                <option value="">Select Employee</option>
                                {% for employee in filtered_employees %}
                                    <option value="{{ employee.id }}">{{ employee.user.first_name }} {{ employee.user.last_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        {% else %}
                        <input type="hidden" name="assigned_to" value="{{ user_department.id }}">
                        {% endif %}
                        <div class="text-end">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="submit" class="btn btn-success"> Done </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Project Tasks Modal -->
    <div class="modal fade" id="projectTasksModal" tabindex="-1" aria-labelledby="projectTasksModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-scrollable modal-lg">
            <div class="modal-content text-white" style="background-color: #121212; border-radius: 24px;">
                <div class="modal-header border-bottom border-secondary">
                    <h5 class="modal-title fw-bold" id="projectTasksModalLabel">Project Tasks</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <div class="input-group">
                            <input type="text" class="form-control bg-dark text-white border-secondary" id="projectTasksSearchInput" placeholder="Search by task name or username...">
                        </div>
                    </div>
                    <div class="row" id="projectTasksContainer">
                        <!-- Tasks will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- File Upload and Report Modal -->
    <div class="modal fade" id="viewFilesModal" tabindex="-1" aria-labelledby="viewFilesModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content text-white" style="background-color: #121212; border-radius: 24px;">
                <div class="modal-header border-bottom border-secondary">
                    <h5 class="modal-title fw-bold" id="viewFilesModalLabel">Task Files & Report</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- File Section -->
                    <div class="mb-3">
                        <label class="form-label">Uploaded File:</label>
                        <div id="fileDisplay">
                            <div class="mb-2">
                                <a href="#" class="btn btn-outline-primary btn-sm file-link">
                                    <i class="fas fa-file"></i> <span class="file-name"></span>
                                </a>
                            </div>
                        </div>
                        <div id="uploadFileSection">
                            <form class="uploadFileForm" method="post" action="{% url 'upload_task_file' task_id=0 %}" enctype="multipart/form-data">
                                {% csrf_token %}
                                <input type="hidden" name="task_id" id="fileTaskId">
                                <input type="file" name="myfile" class="form-control bg-dark text-white border-secondary mb-2" required>
                                <button type="submit" class="btn btn-danger btn-sm">Upload File</button>
                            </form>
                        </div>
                        <div id="uploadMessage"></div>
                    </div>
                    <!-- Report Section -->
                    <div class="mb-3">
                        <label class="form-label">Report:</label>
                        <div id="reportDisplay">
                            <div class="border p-3 mb-3 report-content bg-dark"></div>
                        </div>
                        <div id="uploadReportSection">
                            <form class="uploadReportForm" method="POST" action="{% url 'upload_task_report' task_id=0 %}" class="mt-2">
                                {% csrf_token %}
                                <input type="hidden" name="task_id" id="reportTaskId">
                                <textarea name="report" class="form-control bg-dark text-white border-secondary mb-2" rows="3" required placeholder="Enter your task report here..."></textarea>
                                <button type="submit" class="btn btn-danger btn-sm">Submit Report</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
   
    <script>
      window.USER_ROLE = "{{ user_role }}";
    </script>
{% endblock %}
